/*
 *  Copyright 2017 Zhenfei Zhang @ onboard security
 *
 *  This file is part of pqNTRUSign signature scheme with bimodal
 *  Gaussian sampler (Gaussian-pqNTRUSign).
 *
 *  This software is released under GPL:
 *  you can redistribute it and/or modify it under the terms of the
 *  GNU General Public License as published by the Free Software
 *  Foundation, either version 2 of the License, or (at your option)
 *  any later version.
 *
 *  You should have received a copy of the GNU General Public License.
 *  If not, see <http://www.gnu.org/licenses/>.
*/

#include <string.h>
#include "param.h"



/*
 * NTT pre-computed params for x^1024 + 1 mod 2^16+1
 */

static int64_t roots1024[1024] = 
{65504, 65471, 65405, 65273, 65096, 65009, 64888, 64834, 64698, 64655, 64620, 64612, 64544, 64502, 64481, 64310, 64239, 64160, 64131, 63902, 63859, 63773, 63760, 63754, 63710, 63703, 63687, 63552, 63551, 63532, 63520, 63490, 63467, 63425, 63226, 63086, 63083, 62941, 62842, 62783, 62725, 62394, 62384, 62312, 62267, 62232, 62181, 62009, 61983, 61974, 61971, 61914, 61883, 61869, 61837, 61738, 61690, 61638, 61567, 61565, 61552, 61527, 61503, 61443, 61397, 61313, 60996, 60934, 60915, 60884, 60790, 60784, 60730, 60635, 60629, 60552, 60356, 60345, 60147, 60126, 60084, 60029, 59942, 59913, 59786, 59748, 59636, 59610, 59562, 59450, 59444, 59364, 59251, 59231, 59212, 59200, 59190, 59087, 59044, 58997, 58986, 58927, 58825, 58688, 58590, 58550, 58481, 58464, 58444, 58429, 58418, 58411, 58405, 58382, 58362, 58291, 58229, 58201, 58137, 57968, 57939, 57843, 57758, 57748, 57739, 57597, 57593, 57567, 57517, 57469, 57426, 57400, 57349, 57257, 57240, 57122, 57089, 57056, 57008, 56952, 56892, 56870, 56864, 56744, 56626, 56604, 56598, 56584, 56526, 56455, 56448, 56331, 56293, 56231, 56043, 56031, 55923, 55896, 55828, 55748, 55733, 55721, 55576, 55567, 55175, 55153, 55122, 55026, 54792, 54757, 54715, 54631, 54521, 54382, 54372, 54347, 54292, 54289, 54174, 54162, 54035, 53959, 53946, 53812, 53735, 53696, 53683, 53587, 53402, 53363, 53351, 53191, 52965, 52958, 52925, 52908, 52887, 52880, 52868, 52863, 52843, 52762, 52642, 52637, 52551, 52546, 52516, 52457, 52435, 52408, 52320, 52317, 52310, 52113, 52084, 51964, 51944, 51839, 51643, 51600, 51580, 51563, 51425, 51391, 51386, 51351, 51321, 51314, 51299, 51285, 51273, 51227, 51187, 51100, 51045, 50926, 50921, 50865, 50776, 50737, 50734, 50696, 50676, 50628, 50600, 50516, 50448, 50399, 50341, 50316, 50288, 50149, 49979, 49959, 49941, 49657, 49654, 49649, 49597, 49497, 49401, 49384, 49382, 49315, 49263, 49161, 48977, 48943, 48894, 48846, 48744, 48707, 48696, 48641, 48575, 48540, 48479, 48367, 48262, 48247, 48203, 48191, 48178, 48002, 47966, 47951, 47800, 47754, 47715, 47671, 47659, 47631, 47566, 47515, 47416, 47406, 47373, 47364, 47359, 47208, 47125, 47049, 46986, 46925, 46918, 46900, 46549, 46525, 46364, 46312, 46309, 46255, 46119, 46008, 45959, 45929, 45905, 45846, 45615, 45597, 45500, 45452, 45182, 45114, 44992, 44980, 44834, 44813, 44769, 44760, 44707, 44660, 44620, 44515, 44498, 44230, 44064, 44047, 43977, 43893, 43826, 43725, 43624, 43505, 43422, 43288, 43227, 43207, 43157, 43120, 43047, 43041, 42980, 42946, 42811, 42787, 42614, 42533, 42381, 42355, 42087, 42078, 42044, 41933, 41855, 41834, 41829, 41754, 41660, 41637, 41554, 41536, 41448, 41406, 41267, 41189, 41165, 41114, 41090, 40846, 40845, 40710, 40393, 40379, 40313, 40279, 40237, 40223, 40199, 40189, 40170, 40149, 40074, 39987, 39880, 39844, 39747, 39737, 39565, 39555, 39495, 39382, 39377, 39333, 39279, 39264, 39216, 39156, 39103, 39097, 39083, 39058, 38836, 38689, 38631, 38564, 38456, 38450, 38391, 38351, 38346, 38141, 38024, 37976, 37749, 37663, 37623, 37589, 37313, 37274, 37245, 37238, 37235, 37224, 37165, 37105, 37102, 37091, 37061, 37033, 37009, 36976, 36917, 36837, 36824, 36663, 36658, 36553, 36356, 36346, 36328, 36315, 36305, 36262, 36242, 36193, 36044, 36015, 35942, 35937, 35931, 35855, 35815, 35812, 35756, 35732, 35719, 35663, 35644, 35566, 35495, 35474, 35359, 35261, 35172, 35145, 35142, 35095, 35070, 35039, 34761, 34718, 34692, 34668, 34580, 34550, 34421, 34381, 34345, 34340, 34116, 33994, 33924, 33792, 33777, 33771, 33761, 33682, 33660, 33657, 33586, 33457, 33382, 33286, 33265, 33231, 33227, 33188, 33120, 33093, 32989, 32785, 32752, 32548, 32444, 32417, 32349, 32310, 32306, 32272, 32251, 32155, 32080, 31951, 31880, 31877, 31855, 31776, 31766, 31760, 31745, 31613, 31543, 31421, 31197, 31192, 31156, 31116, 30987, 30957, 30869, 30845, 30819, 30776, 30498, 30467, 30442, 30395, 30392, 30365, 30276, 30178, 30063, 30042, 29971, 29893, 29874, 29818, 29805, 29781, 29725, 29722, 29682, 29606, 29600, 29595, 29522, 29493, 29344, 29295, 29275, 29232, 29222, 29209, 29191, 29181, 28984, 28879, 28874, 28713, 28700, 28620, 28561, 28528, 28504, 28476, 28446, 28435, 28432, 28372, 28313, 28302, 28299, 28292, 28263, 28224, 27948, 27914, 27874, 27788, 27561, 27513, 27396, 27191, 27186, 27146, 27087, 27081, 26973, 26906, 26848, 26701, 26479, 26454, 26440, 26434, 26381, 26321, 26273, 26258, 26204, 26160, 26155, 26042, 25982, 25972, 25800, 25790, 25693, 25657, 25550, 25463, 25388, 25367, 25348, 25338, 25314, 25300, 25258, 25224, 25158, 25144, 24827, 24692, 24691, 24447, 24423, 24372, 24348, 24270, 24131, 24089, 24001, 23983, 23900, 23877, 23783, 23708, 23703, 23682, 23604, 23493, 23459, 23450, 23182, 23156, 23004, 22923, 22750, 22726, 22591, 22557, 22496, 22490, 22417, 22380, 22330, 22310, 22249, 22115, 22032, 21913, 21812, 21711, 21644, 21560, 21490, 21473, 21307, 21039, 21022, 20917, 20877, 20830, 20777, 20768, 20724, 20703, 20557, 20545, 20423, 20355, 20085, 20037, 19940, 19922, 19691, 19632, 19608, 19578, 19529, 19418, 19282, 19228, 19225, 19173, 19012, 18988, 18637, 18619, 18612, 18551, 18488, 18412, 18329, 18178, 18173, 18164, 18131, 18121, 18022, 17971, 17906, 17878, 17866, 17822, 17783, 17737, 17586, 17571, 17535, 17359, 17346, 17334, 17290, 17275, 17170, 17058, 16997, 16962, 16896, 16841, 16830, 16793, 16691, 16643, 16594, 16560, 16376, 16274, 16222, 16155, 16153, 16136, 16040, 15940, 15888, 15883, 15880, 15596, 15578, 15558, 15388, 15249, 15221, 15196, 15138, 15089, 15021, 14937, 14909, 14861, 14841, 14803, 14800, 14761, 14672, 14616, 14611, 14492, 14437, 14350, 14310, 14264, 14252, 14238, 14223, 14216, 14186, 14151, 14146, 14112, 13974, 13957, 13937, 13894, 13698, 13593, 13573, 13453, 13424, 13227, 13220, 13217, 13129, 13102, 13080, 13021, 12991, 12986, 12900, 12895, 12775, 12694, 12674, 12669, 12657, 12650, 12629, 12612, 12579, 12572, 12346, 12186, 12174, 12135, 11950, 11854, 11841, 11802, 11725, 11591, 11578, 11502, 11375, 11363, 11248, 11245, 11190, 11165, 11155, 11016, 10906, 10822, 10780, 10745, 10511, 10415, 10384, 10362, 9970, 9961, 9816, 9804, 9789, 9709, 9641, 9614, 9506, 9494, 9306, 9244, 9206, 9089, 9082, 9011, 8953, 8939, 8933, 8911, 8793, 8673, 8667, 8645, 8585, 8529, 8481, 8448, 8415, 8297, 8280, 8188, 8137, 8111, 8068, 8020, 7970, 7944, 7940, 7798, 7789, 7779, 7694, 7598, 7569, 7400, 7336, 7308, 7246, 7175, 7155, 7132, 7126, 7119, 7108, 7093, 7073, 7056, 6987, 6947, 6849, 6712, 6610, 6551, 6540, 6493, 6450, 6347, 6337, 6325, 6306, 6286, 6173, 6093, 6087, 5975, 5927, 5901, 5789, 5751, 5624, 5595, 5508, 5453, 5411, 5390, 5192, 5181, 4985, 4908, 4902, 4807, 4753, 4747, 4653, 4622, 4603, 4541, 4224, 4140, 4094, 4034, 4010, 3985, 3972, 3970, 3899, 3847, 3799, 3700, 3668, 3654, 3623, 3566, 3563, 3554, 3528, 3356, 3305, 3270, 3225, 3153, 3143, 2812, 2754, 2695, 2596, 2454, 2451, 2311, 2112, 2070, 2047, 2017, 2005, 1986, 1985, 1850, 1834, 1827, 1783, 1777, 1764, 1678, 1635, 1406, 1377, 1298, 1227, 1056, 1035, 993, 925, 917, 882, 839, 703, 649, 528, 441, 264, 132, 66, 33};
static int64_t invntt1024[1024] =
{63551, 64544, 32272, 16136, 50676, 8068, 5453, 36917, 4140, 25338, 52887, 17571, 65471, 3356, 4034, 35359, 35495, 30365, 51227, 29181, 2070, 12669, 27513, 23708, 37091, 59212, 41554, 63490, 65504, 11375, 2112, 63552, 1678, 2017, 39844, 42087, 50448, 50516, 23783, 47951, 58382, 58927, 39264, 47715, 47359, 59251, 1035, 39103, 46525, 36015, 11854, 53363, 51314, 29606, 20777, 30845, 30869, 27146, 31745, 32752, 18551, 38456, 1056, 31776, 839, 33777, 18329, 22923, 19922, 27874, 49384, 51321, 32080, 53812, 25224, 7073, 33382, 25258, 44660, 9641, 649, 56744, 35937, 29191, 15578, 20423, 29209, 7132, 19173, 58291, 49263, 37976, 62232, 19632, 63703, 35566, 57008, 56626, 34550, 56448, 46119, 62394, 33286, 22726, 57122, 22249, 52320, 4985, 44064, 56031, 29818, 50776, 5927, 62725, 31951, 59450, 25657, 14803, 43157, 8953, 48191, 48203, 50288, 11502, 13573, 48641, 16376, 42044, 19228, 528, 21913, 53351, 15888, 33188, 33120, 58590, 49657, 56604, 59190, 12657, 33682, 50149, 50341, 60029, 59087, 57056, 22310, 7569, 41267, 41933, 58997, 44230, 9961, 13937, 24692, 58429, 16040, 5411, 52435, 30442, 26906, 12612, 9244, 36305, 16691, 12629, 35855, 31880, 46312, 22330, 37589, 33093, 28372, 17878, 21560, 50737, 30819, 47364, 13698, 2005, 7789, 42980, 41637, 60635, 47373, 44992, 3566, 42355, 47515, 61914, 57400, 18988, 31116, 52762, 9816, 10384, 64620, 8585, 1764, 17783, 28504, 52958, 52516, 28313, 17275, 34345, 52642, 28224, 55828, 51580, 58481, 31197, 24001, 16643, 19608, 7798, 44834, 11363, 28561, 9306, 52408, 43893, 26160, 35261, 33924, 22032, 60784, 61883, 14909, 25388, 35732, 64131, 48744, 19529, 29725, 20355, 45597, 40170, 58411, 54347, 7336, 44707, 65096, 14238, 49382, 62941, 63083, 37245, 56864, 19578, 57758, 56870, 25144, 5751, 39555, 57089, 20037, 8188, 21022, 9614, 264, 60790, 50600, 43725, 59444, 7944, 16594, 16560, 13424, 10362, 51187, 29295, 17290, 57597, 28302, 37274, 29595, 39097, 12986, 16841, 57843, 57939, 43047, 26155, 925, 62783, 38564, 12674, 62312, 28528, 11155, 36553, 31421, 53402, 31877, 23459, 53735, 54289, 62267, 4541, 22115, 37749, 3985, 39737, 23703, 33994, 12346, 61983, 5975, 54792, 8020, 35474, 58986, 14437, 15221, 13453, 6306, 30467, 4622, 50921, 15883, 29344, 14611, 5789, 53696, 41448, 51944, 41114, 39083, 3700, 50696, 60147, 28299, 15940, 29275, 56331, 58444, 23156, 11165, 51563, 28713, 49315, 8111, 14186, 18412, 6987, 8939, 10780, 58137, 27186, 48178, 23682, 53959, 36315, 6849, 33771, 4603, 36663, 21490, 53587, 63086, 18131, 57567, 56455, 22496, 18619, 1783, 2695, 40189, 53946, 63687, 13227, 44980, 39565, 56526, 30957, 28700, 44813, 38689, 29874, 9494, 25463, 15558, 26381, 4908, 5192, 32310, 37061, 882, 41660, 50865, 14252, 24827, 26479, 7308, 63226, 26258, 46925, 41406, 49941, 26321, 17535, 14112, 27914, 25790, 62384, 26042, 25158, 62009, 48367, 44769, 25550, 36044, 41090, 9804, 47800, 61527, 38141, 3899, 22417, 29781, 38450, 1777, 59364, 47049, 4653, 26204, 54715, 13080, 48540, 50399, 20917, 16962, 12900, 11016, 30392, 30776, 63710, 40223, 12694, 17866, 13894, 64834, 24372, 21711, 42533, 30498, 47631, 1635, 5624, 5901, 42946, 55567, 21039, 16830, 20085, 38836, 61974, 17058, 59942, 3668, 55122, 32548, 14492, 27191, 51273, 7119, 24691, 34381, 59200, 64239, 46255, 64310, 51391, 1377, 28432, 32306, 9789, 19691, 28879, 28435, 11245, 3799, 3847, 24348, 59044, 12572, 35644, 52546, 13220, 17971, 46900, 51386, 3970, 61313, 42787, 4094, 56892, 18121, 10511, 7175, 4807, 60356, 58825, 132, 30395, 25300, 57257, 57240, 54631, 29722, 3972, 61565, 35815, 10906, 8297, 8280, 40237, 35142, 65405, 6712, 5181, 60730, 58362, 55026, 47416, 8645, 61443, 22750, 4224, 61567, 14151, 18637, 47566, 52317, 12991, 29893, 52965, 6493, 41189, 61690, 61738, 54292, 37102, 36658, 45846, 55748, 33231, 37105, 64160, 14146, 1227, 19282, 1298, 6337, 31156, 40846, 58418, 14264, 38346, 51045, 32989, 10415, 61869, 5595, 48479, 3563, 26701, 45452, 48707, 44498, 9970, 22591, 59636, 59913, 63902, 17906, 35039, 23004, 43826, 41165, 703, 51643, 47671, 52843, 25314, 1827, 34761, 35145, 54521, 52637, 48575, 44620, 15138, 16997, 52457, 10822, 39333, 60884, 18488, 6173, 63760, 27087, 35756, 43120, 61638, 27396, 4010, 17737, 55733, 24447, 29493, 39987, 20768, 17170, 3528, 40379, 39495, 3153, 39747, 37623, 51425, 48002, 39216, 15596, 24131, 18612, 39279, 2311, 58229, 39058, 40710, 51285, 14672, 23877, 64655, 28476, 33227, 60345, 60629, 39156, 49979, 40074, 56043, 35663, 26848, 20724, 36837, 34580, 9011, 25972, 20557, 52310, 1850, 11591, 25348, 62842, 63754, 46918, 43041, 9082, 7970, 47406, 2451, 11950, 44047, 28874, 60934, 31766, 58688, 29222, 11578, 41855, 17359, 38351, 7400, 54757, 56598, 58550, 47125, 51351, 57426, 16222, 36824, 13974, 54372, 42381, 7093, 9206, 36262, 49597, 37238, 5390, 14841, 61837, 26454, 24423, 13593, 24089, 11841, 59748, 50926, 36193, 49654, 14616, 60915, 35070, 59231, 52084, 50316, 51100, 6551, 30063, 57517, 10745, 59562, 3554, 53191, 31543, 41834, 25800, 61552, 27788, 43422, 60996, 3270, 11248, 11802, 42078, 33660, 12135, 34116, 28984, 54382, 37009, 3225, 52863, 26973, 2754, 64612, 39382, 22490, 7598, 7694, 48696, 52551, 26440, 35942, 28263, 37235, 7940, 48247, 36242, 14350, 55175, 52113, 48977, 48943, 57593, 6093, 21812, 14937, 4747, 65273, 55923, 44515, 57349, 45500, 8448, 25982, 59786, 40393, 8667, 7779, 45959, 8673, 28292, 2454, 2596, 16155, 51299, 441, 20830, 58201, 11190, 7126, 25367, 19940, 45182, 35812, 46008, 16793, 1406, 29805, 40149, 50628, 3654, 4753, 43505, 31613, 30276, 39377, 21644, 13129, 56231, 36976, 54174, 20703, 57739, 45929, 48894, 41536, 34340, 7056, 13957, 9709, 37313, 12895, 31192, 48262, 37224, 13021, 12579, 37033, 47754, 63773, 56952, 917, 55153, 55721, 12775, 34421, 46549, 8137, 3623, 18022, 23182, 61971, 20545, 18164, 4902, 23900, 22557, 57748, 63532, 51839, 18173, 34718, 14800, 43977, 47659, 37165, 32444, 27948, 43207, 19225, 33657, 29682, 52908, 48846, 29232, 56293, 52925, 38631, 35095, 13102, 60126, 49497, 7108, 40845, 51600, 55576, 21307, 6540, 23604, 24270, 57968, 43227, 8481, 6450, 5508, 15196, 15388, 31855, 52880, 6347, 8933, 15880, 6947, 32417, 32349, 49649, 12186, 43624, 65009, 46309, 23493, 49161, 16896, 51964, 54035, 15249, 17334, 17346, 56584, 22380, 50734, 39880, 6087, 33586, 2812, 59610, 14761, 35719, 9506, 21473, 60552, 13217, 43288, 8415, 42811, 32251, 3143, 19418, 9089, 30987, 8911, 8529, 29971, 1834, 45905, 3305, 27561, 16274, 7246, 46364, 58405, 36328, 45114, 49959, 36346, 29600, 8793, 64888, 55896, 20877, 40279, 32155, 58464, 40313, 11725, 33457, 14216, 16153, 37663, 45615, 42614, 47208, 31760, 64698, 33761, 64481, 27081, 46986, 32785, 33792, 38391, 34668, 34692, 44760, 35931, 14223, 12174, 53683, 29522, 19012, 26434, 64502, 6286, 18178, 17822, 26273, 6610, 7155, 17586, 41754, 15021, 15089, 23450, 25693, 63520, 63859, 1985, 63425, 54162, 33, 2047, 23983, 6325, 28446, 41829, 38024, 52868, 63467, 36356, 14310, 35172, 30042, 30178, 61503, 62181, 66, 47966, 12650, 40199, 61397, 28620, 60084, 57469, 14861, 49401, 33265, 993, 1986};

static PQ_PARAM_SET pqParamSets[] = {
    {
        Gaussian_1024_205,    /* parameter set id */
        "gaussian-1024-107",  /* human readable name */
        {0xff, 0xff, 0xf9},  /* OID */
        10,                   /* bitlength of N */
        17,                  /* bitlength of q */
        1024,                 /* ring degree */
        2,                   /* message space prime */
        65537,               /* ring modulus */
        40,                  /* max infty norm of the F norm for secret keys */
        500,                 /* max l2 norm of f*a convolution (Gaussian only)*/
        49,                  /* max norm of g*a convolution */
        0,                   /* (q/2 - B_s)/p (uniform only)*/
        (1<<15)-49,          /* q/2 - B_t */
        7.38905609893065,    /* rejection rate on s side: e^2 (Gaussian only)*/
        205,                  /* Product form +1/-1 counts */
        1024,                 /* # Polynomial coefficients for Karatsuba */
        250,                 /* std dev */
        /* NTT param */
        roots1024,
        invntt1024,
        65473,
    },

    {
        Uniform_1024_205,     /* parameter set id */
        "Uniform_1024_107",   /* human readable name */
        {0xff, 0xff, 0xf9},  /* OID */
        10,                   /* bitlength of N */
        17,                  /* bitlength of q */
        1024,                 /* ring degree */
        2,                   /* message space prime */
        65537,               /* ring modulus */
        40,                  /* max infty norm of the F norm for secret keys */
        0,                   /* max l2 norm of f*a convolution (Gaussian only)*/
        49,                  /* max norm of g*a convolution */
        16384-25,            /* (q/2 - B_s)/p (uniform only)*/
        (1<<15)-49,          /* q/2 - B_t */
        0,                   /* rejection rate on s side: e^2 (Gaussian only)*/
        205,                  /* Product form +1/-1 counts */
        1024,                 /* # Polynomial coefficients for Karatsuba */
        0,                   /* std dev (Gaussian only)*/
        /* NTT param */
        roots1024,
        invntt1024,
        65473,
    },


};

static int numParamSets = sizeof(pqParamSets)/sizeof(PQ_PARAM_SET);

PQ_PARAM_SET *
pq_get_param_set_by_id(PQ_PARAM_SET_ID id)
{
    int i;

    for(i=0; i<numParamSets; i++)
    {
        if(pqParamSets[i].id == id)
        {
            return (pqParamSets + i);
        }
    }
    return NULL;
}
